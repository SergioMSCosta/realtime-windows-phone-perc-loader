/*
 * xRTML JavaScript Library 2.0.1
 * http://www.xrtml.org/
 *
 * Copyright 2011-2012, IBT, SA
 *
 * xRTML is part of our framework and it's powered by the world's first Real-Time Web Platform by IBT
 *
 * Join our movement to transform the World Wide Web into the Real-Time Web!
 *
 * Interested in Real-Time technology? See what we can do for your business today.
 *
 * Transform your old website into an exciting Real-Time experience!
 *
 * Improve the interaction with your visitor to a level never seen before
 * and increase visitor recurrency and loyalty.
 *
 * Visit us at www.realtime.co and learn more.
 */
var Events={};Events.Provider=function(target){this.listeners={};if(!target.listeners){target.listeners=this.listeners;}target.addEventListener=this.addEventListener;target.removeEventListener=this.removeEventListener;target.resetEventListener=this.resetEventListener;target.dispatchEvent=this.dispatchEvent;};Events.Provider.prototype={constructor:Events.Provider,addEventListener:function(type,listener){if(!this.listeners[type]){this.listeners[type]=[];}this.listeners[type].push(listener);},removeEventListener:function(type,listener){if(this.listeners[type] instanceof Array){var listeners=this.listeners[type];for(var i=0,len=listeners.length;i<len;i++){if(listeners[i]===listener){listeners.splice(i,1);break;}}}},resetEventListener:function(type){if(this.listeners[type] instanceof Array){this.listeners[type]=[];}},dispatchEvent:function(type,data){if(!type){throw new Error("Event object missing 'type' property.");}var event={type:type,target:this};for(var key in data){var obj=data[key];event[key]=obj;}if(this.listeners[event.type] instanceof Array){var listeners=this.listeners[event.type];var result;for(var i=0,len=listeners.length;i<len;i++){var listener=listeners[i];try{listeners[i].call(this,event);if(typeof(result)!=="undefined"&&result!==null){this.result=result;}}catch(err){xRTML.Console.error("Error calling listener for event "+event.type+" . Continuing execution...");xRTML.Console.error(err);}}}}};Events.Manager={addEventListener:function(element,type,callback){if(element.addEventListener){element.addEventListener(type,callback,false);}else{element.attachEvent?element.attachEvent("on"+type,callback):element[type]=callback;}},removeEventListener:function(element,type,listener,useCapture){if(element.removeEventListener){if(!useCapture){useCapture=false;}element.removeEventListener(type,listener,useCapture);}else{if(element.detachEvent){element.detachEvent("on"+type,listener);listener.delegate=null;}}return this;}};window.xRTML=(function(){var ConnectionManager=(function(){var instance=(function(){var connections={},clientFactory=(function(){var BaseFactory=function(factoryName){var name=factoryName,factory=null,pendingRequests=[],self=this,isLoaded=function(){return null!=factory;},onLoadOrtcFactory=function(ortcFactory,error){if(error!=null){xRTML.Console.error("ConnectionManager: Factory "+name+" load error: "+error.code+" : "+error.message);}else{xRTML.Console.debug("ConnectionManager: Factory "+name+" loaded.");factory=ortcFactory;if(pendingRequests.length!=0){for(var i=0;i<pendingRequests.length;++i){self.createClient(pendingRequests[i]);}pendingRequests=[];}}};this.createClient=function(request){if(isLoaded()){var ortcClient=factory.createClient();request.callback({client:ortcClient});return ortcClient;}else{loadOrtcFactory(name,onLoadOrtcFactory);pendingRequests.push(request);}};},factories={IbtRealTimeS:new BaseFactory("IbtRealTimeS"),IbtRealTimeK:new BaseFactory("IbtRealTimeK"),IbtRealTimeSJ:new BaseFactory("IbtRealTimeSJ")},create=function(clientType,request){var gateway=factories[clientType];gateway.createClient(request);};return{create:create};})();var createConnection=function(connectionJSON){for(var prop in connectionJSON){if(prop.match(/[A-Z]/)){connectionJSON[prop.toLowerCase()]=connectionJSON[prop];delete connectionJSON[prop];}}var connection=new xRTML.Tags.Connection(connectionJSON);this.dispatchEvent("onConnectionCreated",{connection:connection});connections[connection.internalId]=connection;connection.addEventListener("onXrtmlMessage",function(e){instance.dispatchEvent("onXrtmlMessage",e);});clientFactory.create(connection.serverType,{id:connection.internalId,callback:connection.onClientCreated});},loadConnections=function(){var ns=window.addEventListener?"xrtml:":"",connectionTags=document.getElementsByTagName(ns+"connection");for(var i=0;i<connectionTags.length;i++){var connectionElem=connectionTags[i],connectionJSON={name:"Connection",id:connectionElem.getAttribute("id"),active:connectionElem.getAttribute("active"),sendretries:connectionElem.getAttribute("sendretries"),sendinterval:connectionElem.getAttribute("sendinterval"),url:connectionElem.getAttribute("url"),iscluster:connectionElem.getAttribute("iscluster"),servertype:connectionElem.getAttribute("servertype"),timeout:connectionElem.getAttribute("timeout"),connectattempts:connectionElem.getAttribute("connectattempts"),metadata:connectionElem.getAttribute("metadata"),appkey:connectionElem.getAttribute("appkey"),authtoken:connectionElem.getAttribute("authtoken"),channels:(function(){var channelTags=document.getElementsByTagName(ns+"channels")[0].children,channels=[];for(var i=0;i<channelTags.length;++i){var channelTag=channelTags[i];channels.push({name:channelTag.getAttribute("name"),subscribeOnReconnect:channelTag.getAttribute("subscribeonreconnect")?channelTag.getAttribute("subscribeonreconnect"):true,subscribe:channelTag.getAttribute("subscribe")?channelTag.getAttribute("subscribe"):true,onMessage:channelTag.getAttribute("onmessage")?new Function("event","return "+channelTag.getAttribute("onmessage")+"(event);"):null,messageAdapter:channelTag.getAttribute("messageadapter")?new Function("message","return "+channelTag.getAttribute("messageadapter")+"(message);"):null});}return channels;})(),oncreated:connectionElem.getAttribute("oncreated")?new Function("event","return "+connectionElem.getAttribute("oncreated")+"(event);"):null,onconnected:connectionElem.getAttribute("onconnected")?new Function("event","return "+connectionElem.getAttribute("onconnected")+"(event);"):null,ondisconnected:connectionElem.getAttribute("ondisconnected")?new Function("event","return "+connectionElem.getAttribute("ondisconnected")+"(event);"):null,onsubscribed:connectionElem.getAttribute("onsubscribed")?new Function("event","channel","return "+connectionElem.getAttribute("onsubscribed")+"(event);"):null,onunsubscribed:connectionElem.getAttribute("onunsubscribed")?new Function("event","channel","return "+connectionElem.getAttribute("onunsubscribed")+"(event);"):null,onexception:connectionElem.getAttribute("onexception")?new Function("event","event","return "+connectionElem.getAttribute("onexception")+"(event);"):null,onreconnected:connectionElem.getAttribute("onreconnected")?new Function("event","return "+connectionElem.getAttribute("onreconnected")+"(event);"):null,onreconnecting:connectionElem.getAttribute("onreconnecting")?new Function("event","return "+connectionElem.getAttribute("onreconnecting")+"(event);"):null,onmessage:connectionElem.getAttribute("onmessage")?new Function("event","return "+connectionElem.getAttribute("onmessage")+"(event);"):null,messageadapter:connectionElem.getAttribute("messageadapter")?new Function("message","return "+connectionElem.getAttribute("messageadapter")+"(message);"):null};this.createConnection(connectionJSON);}},getConnectionByInternalId=function(internalId){return connections[internalId];},getConnectionById=function(id){for(var key in connections){if(connections[key].id===id){return connections[key];}}return null;},addConnectionChannel=function(connectionId,channel){var connection=getConnectionByInternalId(connectionId);if(connection===null){connection=getConnectionById(connectionId);if(connection===null){throw xRTML.Console.error("Connection with "+connectionId+" not found");}}connection.addChannel(channel);},sendMessage=function(channelName,message,sendOnly){for(var name in connections){connections[name].send(channelName,message,sendOnly);}};return{createConnection:createConnection,sendMessage:sendMessage,loadConnections:loadConnections,getConnectionByInternalId:getConnectionByInternalId,getConnectionById:getConnectionById,addConnectionChannel:addConnectionChannel};})();new Events.Provider(instance);ConnectionManager=function(){return instance;};return ConnectionManager();})(),TagManager=(function(){var instance=(function(){var tags=[],tagInstances={},xrtmlElement=function(node,parent){var attribute,child;if(node.attributes){for(var i=0;i<node.attributes.length;++i){attribute=node.attributes[i];if(attribute.specified){this[attribute.nodeName.toLowerCase()]=attribute.nodeValue;}}}if(node.children.length!=0){for(var j=0;j<node.children.length;++j){child=node.children[j],childName=window.addEventListener?child.nodeName.split(":")[1].toLowerCase():child.nodeName.toLowerCase();if(childName==="template"){this[childName]="";if(window.addEventListener){for(var z=0;z<child.childNodes.length;++z){if(child.childNodes[z].nodeType==Node.COMMENT_NODE){this[childName]+=child.childNodes[z].nodeValue;}}}else{this[childName]=child.childNodes[0].nodeValue;}this[childName]=this[childName].trim();continue;}if(!parent){this[childName]=[];new xrtmlElement(child,this[childName]);}else{parent.push(new xrtmlElement(child));if(child.children){new xrtmlElement(child,parent);}}}}},loadTags=function(){xRTML.Console.debug("Loading tags from DOM... ");var ns=window.addEventListener?"xrtml:":"",tagElements;for(var j=0;j<tags.length;++j){tagElements=document.getElementsByTagName(ns+tags[j]);for(var i=0;i<tagElements.length;++i){if(!window.addEventListener&&tagElements[i].scopeName.toLowerCase()!="xrtml"){continue;}var xrtmlTag=new xrtmlElement(tagElements[i]);xrtmlTag.name=tags[j];createTag(xrtmlTag);}}xRTML.Console.debug("Loading tags from DOM finished.");},createTag=function(tagObject){try{var xrtmlTag=new xRTML.Tags[tagObject.name](tagObject);xrtmlTag.addEventListener("dispose",function(e){var tagInternalId=e.tag.internalId,disposedTag=tagInstances[tagInternalId];tagInstances[tagInternalId]=null;delete tagInstances[tagInternalId];TagManager.dispatchEvent("onTagDisposed",{tag:e.tag});});tagInstances[xrtmlTag.internalId]=xrtmlTag;TagManager.dispatchEvent("onTagCreated",{name:tagObject.name,tag:xrtmlTag});return xrtmlTag;}catch(err){xRTML.Console.error(err);}},registerTag=function(tagName){tags.push(tagName);},getTagByInternalId=function(id){return tagInstances[id];},getTagById=function(id){for(var internalId in tagInstances){var tag=tagInstances[internalId];if(tag.id&&tag.id===id){return tag;}}xRTML.Console.error("Tag instance with id: "+id+" not found.");};return{loadTags:loadTags,createTag:function(tag){var lTag={};for(var name in tag){lTag[name.toLowerCase()]=tag[name];}return createTag(lTag);},getTagById:getTagById,getTagByInternalId:getTagByInternalId,registerTag:registerTag};})();new Events.Provider(instance);TagManager=function(){return instance;};return TagManager();})(),MessageBroker={triggers:{},registerTrigger:function(trigger){if(!this.triggers[trigger.name]){this.triggers[trigger.name]={};}this.triggers[trigger.name][trigger.tagInternalId]={callback:trigger.callback,mappings:trigger.mappings};this.dispatchEvent("onTriggerRegistered",{trigger:trigger});},unregisterTrigger:function(trigger){var mbTrigger=this.triggers[trigger.name];if(mbTrigger&&mbTrigger[trigger.tagInternalId]){var mbTriggerEntry=mbTrigger[trigger.tagInternalId];trigger.callback=mbTriggerEntry.callback;trigger.mappings=mbTriggerEntry.mappings;delete this.triggers[trigger.name][trigger.tagInternalId];var hasProperties=false;for(var prop in mbTrigger){if(mbTrigger.hasOwnProperty(prop)){hasProperties=true;}}if(!hasProperties){delete this.triggers[trigger.name];}this.dispatchEvent("onTriggerUnregistered",{trigger:trigger});}},registerTriggers:function(e){var tag=e.tag;for(var i=0;i<tag.triggers.length;++i){var trigger=tag.triggers[i];MessageBroker.registerTrigger({tagId:tag.id,tagInternalId:tag.internalId,name:trigger.name,callback:tag.callProcess,mappings:trigger.mappings});}},unregisterTriggers:function(e){var tag=e.tag;for(var i=0;i<tag.triggers.length;++i){var trigger=tag.triggers[i];MessageBroker.unregisterTrigger({tagInternalId:tag.internalId,name:trigger.name});}},triggerCall:function(triggerName,message){if(MessageBroker.triggers[triggerName]){for(var tagInternalId in MessageBroker.triggers[triggerName]){var tag=TagManager.getTagByInternalId(tagInternalId);tag.callProcess(message);}}else{xRTML.Console.debug("Trigger "+triggerName+" is not registered with any xRTML Tag.");}},triggerTags:function(e){var tNames=e.message.trigger;if(typeof tNames=="string"){MessageBroker.triggerCall(tNames,e.message);}else{if(tNames instanceof Array){for(var i=0;i<tNames.length;++i){e.message.trigger=tNames[i].name;MessageBroker.triggerCall(tNames[i].name,e.message);}}}},init:function(){new Events.Provider(this);TagManager.addEventListener("onTagCreated",this.registerTriggers);TagManager.addEventListener("onTagDisposed",this.unregisterTriggers);ConnectionManager.addEventListener("onXrtmlMessage",this.triggerTags);return this;}}.init(),MessageManager={parse:function(message){},isValid:function(message){try{if((typeof message==="string")&&message.toLowerCase().indexOf("xrtml")==1){return true;}if((typeof message==="object")&&message.xrtml){return true;}MessageManager.parse(message);return false;}catch(err){xRTML.getInstance().Console.error("Invalid xRTML message:"+MessageManager.toJSON(message));}},toJson:function(message){if(typeof message==="string"){var xrtmlMessage={xrtml:{senderId:message.s,trigger:message.t,action:message.a,data:typeof message.d==="object"?message.d:JSON.parse(message.d)}};return JSON.parse(xrtmlMessage);}return message;},stringify:function(message){var xrtmlMessage={xrtml:{s:message.senderId,t:message.trigger,a:message.action,d:typeof message.data==="object"?message.data:JSON.parse(message.data)}};return JSON.stringify(xrtmlMessage);},createMessage:function(senderId,trigger,action,data){var message={senderId:senderId,trigger:trigger,action:action,data:typeof data==="object"?data:JSON.parse(data),stringify:function(){return MessageManager.stringify(this);}};return message;}},TraceMonitor={init:function(remote){var sendTrace=function(message,obj){if(remote){var data=null;try{data=JSON.stringify(obj);}catch(e){}var xrtmlMessage=createMessage("","",{message:message,content:data});sendMessage("trace",xrtmlMessage);}};if(remote){xRTML.Console.addEventListener("onError",function(e){sendTrace("Error",e.error);});}ConnectionManager.addEventListener("onConnectionCreated",function(evt){var connection=evt.connection;sendTrace("Connection found: \n AppKey: "+connection.appKey+" \n AuthToken: "+connection.authToken+" \n Url: "+connection.url,connection);connection.addEventListener("onAuthenticated",function(e){var statement="Connection "+(e.connection.id||e.connection.internalId)+": authentication "+(e.isAuthenticated?"successful.":("failed: "+e.error));xRTML.Console.debug(statement);sendTrace(statement,e.connection);});connection.addEventListener("onCreated",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" created. "+(e.client.autoConnect?"Connecting...":"Waiting for explicit connect...");xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onConnected",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" established. Subscribing channels...";xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onDisconnected",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" closed.";xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onSubscribed",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+": Channel "+e.channel+" subscribed.";xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onUnsubscribed",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+": Channel "+e.channel+" unsubscribed.";xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onException",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" threw an exception: "+e.event;xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onReconnected",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" has been restored.";xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onReconnecting",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" was lost. ";if(e.client.connectionAttemptsCounter>=e.client.connectAttempts){statement+="Maximum number of attempts reached: "+e.client.connectAttempts+" Stop trying to reconnect.";}else{statement+="Trying to reconnect. Attempt "+e.client.connectionAttemptsCounter+" out of "+e.client.connectAttempts;}xRTML.Console.debug(statement);sendTrace(statement,e.client);});connection.addEventListener("onMessage",function(e){var statement=typeof e.message==="String"?e.message:JSON.stringify(e.message);xRTML.Console.debug("Connection "+(e.target.id||e.target.internalId)+": Message "+statement+" received from channel "+e.channel);sendTrace(statement,e.target);});});TagManager.addEventListener("onTagCreated",function(e){var tag=e.tag;xRTML.Console.debug("Tag of type "+e.name+" created with id "+(tag.id||tag.internalId));xRTML.Console.debug(tag);tag.addEventListener("onInit",function(e){xRTML.Console.debug("");});tag.addEventListener("onLoad",function(e){xRTML.Console.debug("");});tag.addEventListener("active",function(e){xRTML.Console.debug("");});tag.addEventListener("onprocess",function(e){var statement="Tag "+(e.target.id||e.target.internalId)+": Process message ";xRTML.Console.debug(statement);xRTML.Console.debug(e.data);sendTrace(statement,e.target);});tag.addEventListener("preprocessed",function(e){var statement="Tag "+(e.target.id||e.target.internalId)+": Preprocess message ";xRTML.Console.debug(statement);xRTML.Console.debug(e.data);sendTrace(statement,e.target);});tag.addEventListener("postprocessed",function(e){var statement="Tag "+(e.target.id||e.target.internalId)+": Postprocess message ";xRTML.Console.debug(statement);xRTML.Console.debug(e.data);sendTrace(statement,e.target);});});TagManager.addEventListener("onTagDisposed",function(e){var tag=e.tag,statement="Tag of type "+e.name+" with id "+(tag.id||tag.internalId)+" disposed.";xRTML.Console.debug(statement);sendTrace(statement,e.tag);});MessageBroker.addEventListener("onTriggerRegistered",function(e){var statement="Tag "+(e.trigger.tagId||e.trigger.tagInternalId)+" registered trigger: "+e.trigger.name;xRTML.Console.debug(statement);sendTrace(statement,e.target);});MessageBroker.addEventListener("onTriggerUnregistered",function(e){var statement="Tag "+(e.trigger.tagId||e.trigger.tagInternalId)+" unregistered trigger: "+e.trigger.name;xRTML.Console.debug(statement);sendTrace(statement,e.target);});return this;}},init=function(){try{if(arguments.callee.done){return;}arguments.callee.done=true;xRTML.Config.load();TraceMonitor.init(xRTML.Config.remoteTrace);var start=function(){if(xRTML.Config.xrtmlActive){ConnectionManager.loadConnections();TagManager.loadTags();}xRTML.isReady=true;window.xRTML.dispatchEvent("ready");};if(xRTML.Config.loadORTCScript){xRTML.Common.DOM.loadScript(xRTML.Config.ortcLibrary,function(){start();});}else{start();}}catch(err){xRTML.Console.error(err);}},isXrtmlMessage=function(message){try{return MessageManager.isValid(message);}catch(err){xRTML.Console.error(err);}},createMessage=function(trigger,action,data,senderId){try{return MessageManager.createMessage(senderId,trigger,action,data);}catch(err){xRTML.Console.error(err);}},registerTag=function(tagName){try{return TagManager.registerTag(tagName);}catch(err){xRTML.Console.error(err);}},createTag=function(tagObject){try{return TagManager.createTag(tagObject);}catch(err){xRTML.Console.error(err);}},getTagById=function(id){try{return TagManager.getTagById(id);}catch(err){xRTML.Console.error(err);}},getTagByInternalId=function(internalId){try{return TagManager.getTagByInternalId(internalId);}catch(err){xRTML.Console.error(err);}},sendMessage=function(channel,message,sendOnly){try{var tag=getTagByInternalId(message.senderId);if(typeof tag=="undefined"||tag.active){ConnectionManager.sendMessage(channel,message,sendOnly);}}catch(err){xRTML.Console.error(err);}},createConnection=function(connectionJSON){try{ConnectionManager.createConnection(connectionJSON);}catch(err){xRTML.Console.error(err);}},getConnectionByInternalId=function(internalId){return ConnectionManager.getConnectionByInternalId(internalId);},getConnectionById=function(id){return ConnectionManager.getConnectionById(id);},addConnectionChannel=function(connectionId,channel){ConnectionManager.addConnectionChannel(connectionId,channel);},ready=function(fn){!xRTML.isReady?window.xRTML.addEventListener("ready",fn):fn();};return{Tags:{},isReady:false,ready:ready,init:init,createTag:createTag,registerTag:registerTag,getTagById:getTagById,getTagByInternalId:getTagByInternalId,sendMessage:sendMessage,createMessage:createMessage,isXrtmlMessage:isXrtmlMessage,createConnection:createConnection,getConnectionByInternalId:getConnectionByInternalId,getConnectionById:getConnectionById,addConnectionChannel:addConnectionChannel};})();new Events.Provider(window.xRTML);if(navigator.appName=="Microsoft Internet Explorer"){if(new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null){if(parseFloat(RegExp.$1)<9||document.compatMode=="BackCompat"){document.write("<?xml:namespace prefix = xrtml />");}}}xRTML.Common={Object:{equals:function(o1,o2){if(typeof o1=="object"||(o1).__isArray){for(var p in o1){if(o1.hasOwnProperty(p)){if(!xRTML.Common.Object.equals(o1[p],o2[p])){return false;}}}}else{return o1===o2;}return true;}},Array:{forEach:function(items,fn){if(!items){return;}for(var i=0,len=items.length;i<len;i++){fn(items[i],i);}},indexOf:function(items,obj,start){for(var i=(start||0),j=items.length;i<j;i++){if(xRTML.Common.Object.equals(items[i],obj)){return i;}}return -1;},remove:function(array,from,to){var rest=array.slice((to||from)+1||array.length);array.length=from<0?array.length+from:from;return array.push.apply(array,rest);},contains:function(array,obj){for(var i=0,len=array.length;i<len;i++){if(xRTML.Common.Object.equals(array[i],obj)){return true;}}return false;},removeObj:function(array,obj){if(xRTML.Common.Array.contains(array,obj)){var index=xRTML.Common.Array.indexOf(array,obj);array.splice(index,1);}return array;}},DOM:{browser:function(){var userAgent=window.navigator.userAgent.toLowerCase();var browserNames=["msie","firefox","chrome","safari","gecko"],browserTypes=["ie","mozilla","mozilla","safari","mozilla"],browserType;for(var i=0;i<browserNames.length;i++){if(userAgent.indexOf(browserNames[i])>=0){browserType=browserTypes[i];break;}}return browserType;},getElementsByClassName:function(parent,className){var elements=[];if(parent.getElementsByClassName){elements=parent.getElementsByClassName(className);}else{var walkTheDOM=function(node,func){func(node);node=node.firstChild;while(node){walkTheDOM(node,func);node=node.nextSibling;}};walkTheDOM(parent,function(node){var a,c=node.className,i;if(c){a=c.split(" ");for(i=0;i<a.length;i++){if(a[i]===className){elements.push(node);break;}}}});}return elements;},getText:function(element){if(element){if(element.innerText){return element.innerText;}if(element.innerHTML){return element.innerHTML;}if(element.nextSibling){return element.nextSibling.data;}}return"";},setText:function(element,text){if(element){element.innerHTML=text;element.innerText=text;}},loadScript:function(url,callback){var script=document.createElement("script");script.type="text/javascript";if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;callback();}};}else{script.onload=function(){callback();};}script.src=url;document.getElementsByTagName("head")[0].appendChild(script);},outerHTML:function(node){return node.outerHTML||(function(n){var div=document.createElement("div"),h;div.appendChild(n.cloneNode(true));h=div.innerHTML;div=null;return h;})(node);},getAttribute:function(value){if(parseInt(value)){return parseInt(value);}switch(value.toLowerCase()){case"true":return true;case"false":return false;default:return value;}},toDOMElement:function(source){var div=document.createElement("div");div.innerHTML=content;return div.childNodes;},getNextSibling:function(node){var next=node.nextSibling;while(next.nodeType!==1){next=next.nextSibling;}return next;}},Cookie:{setCookie:function(cookieName,cookieValue,expires,path,domain,secure){var cookieString=cookieName+"="+escape(cookieValue);if(expires){cookieString+="; expires="+expires.toGMTString();}if(path){cookieString+="; path="+escape(path);}else{cookieString+="; path=/";}if(domain){cookieString+="; domain="+escape(domain);}if(secure){cookieString+="; secure";}document.cookie=cookieString;},getCookie:function(cookieName){var results=document.cookie.match("(^|;) ?"+cookieName+"=([^;]*)(;|$)");if(results){return(unescape(results[2]));}return null;},deleteCookie:function(cookieName){var cookieDate=new Date();cookieDate.setTime(cookieDate.getTime()-1);document.cookie=cookieName+="=; expires="+cookieDate.toGMTString();}},Validator:{validateRequired:function(value,throwError,appendToErrorMessage){if((typeof value=="undefined")||value==undefined||value==null||value===""||value==NaN){if(throwError){xRTML.Console.error("Value cannot be empty: "+appendToErrorMessage);}return false;}else{return true;}},validateBoolean:function(value,throwError,appendToErrorMessage){if(value&&(value.toLowerCase()==="true"||value.toLowerCase()==="false")){return true;}else{if(throwError){xRTML.Console.error('Value is neither "true" or "false": '+appendToErrorMessage);}return false;}},validateAlfaNumeric:function(value,throwError,appendToErrorMessage){var alphanum=/^[0-9a-bA-B]+$/;if(!value.match(alphanum)){if(throwError){xRTML.Console.error("Value is not alphanumeric: "+appendToErrorMessage);}return false;}else{return true;}},validateNumeric:function(value,throwError,appendToErrorMessage){var num=/^[0-9]+[.]*[0-9]*$/;if((typeof value=="number")||((typeof value=="string")&&value.match(num))){return true;}else{if(throwError){xRTML.Console.error("Value is not a number. "+appendToErrorMessage);}return false;}},validateJSON:function(value,throwError,appendToErrorMessage){if(value.isJSON()){return true;}else{if(throwError){xRTML.Console.error("Value is not valid JSON notation. "+appendToErrorMessage);}return false;}}},Converter:(function(){var bool={"true":true,"yes":true,"1":true,"false":false,"no":false,"0":false};return{toBoolean:function(value,throwError,appendToErrorMessage){return typeof value==="boolean"?value:typeof value==="string"?bool[value.toLowerCase()]:value;},toNumber:function(value,throwError,appendToErrorMessage){if(typeof value=="number"){return value;}if((typeof value=="string")&&(value.trim()=="")){return 0;}else{if((typeof value!="undefined")&&xRTML.Common.Validator.validateNumeric(value,throwError,appendToErrorMessage)){return Number(value);}}},toJSON:function(value,throwError,appendToErrorMessage){if((typeof value!="undefined"&&value!="")&&xRTML.Common.Validator.validateJSON(value,throwError,appendToErrorMessage)){return JSON.parse(value);}}};})(),Util:(function(){var S4=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);};return{regexIndexOf:function(string,regex,startpos){var indexOf=string.substring(startpos||0).search(regex);return(indexOf>=0)?(indexOf+(startpos||0)):indexOf;},replaceAll:function(string,token,newtoken){while((typeof string=="string")&&(string.indexOf(token)!=-1)){string=string.replace(token,newtoken);}return string;},regexReplaceAll:function(string,regex,newtoken){while((typeof string=="string")&&(this.regexIndexOf(string,regex)!=-1)){string=string.replace(regex,newtoken);}return string;},convertAttributeValueToJSON:function(attributeValue){var parsedValue;if(attributeValue){attributeValue=this.replaceAll(attributeValue,"'",'"');if(typeof attributeValue=="string"){parsedValue=JSON.parse(attributeValue);}else{parsedValue=attributeValue;}}else{xRTML.Console.error("attributeValue is undefined.");}return parsedValue;},guidGenerator:function(){return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());},idGenerator:function(){return(S4()+S4());},printStackTrace:function(error){var ex=error||null;var p={run:function(ex){ex=ex||this.createException();var mode=this.mode(ex);if(mode==="other"){return this.other(arguments.callee);}else{return this[mode](ex);}},createException:function(){try{this.undef();return null;}catch(e){return e;}},mode:function(e){if(e["arguments"]&&e.stack){return(this._mode="chrome");}else{if(e.message&&typeof window!=="undefined"&&window.opera){return(this._mode=e.stacktrace?"opera10":"opera");}else{if(e.stack){return(this._mode="firefox");}}}return(this._mode="other");},chrome:function(e){var stack=(e.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");stack.pop();return stack;},firefox:function(e){return e.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n");},opera10:function(e){var stack=e.stacktrace;var lines=stack.split("\n"),ANON="{anonymous}",lineRE=/.*line (\d+), column (\d+) in ((<anonymous function\:?\s*(\S+))|([^\(]+)\([^\)]*\))(?: in )?(.*)\s*$/i,i,j,len;for(i=2,j=0,len=lines.length;i<len-2;i++){if(lineRE.test(lines[i])){var location=RegExp.$6+":"+RegExp.$1+":"+RegExp.$2;var fnName=RegExp.$3;fnName=fnName.replace(/<anonymous function\:?\s?(\S+)?>/g,ANON);lines[j++]=fnName+"@"+location;}}lines.splice(j,lines.length-j);return lines;},opera:function(e){var lines=e.message.split("\n"),ANON="{anonymous}",lineRE=/Line\s+(\d+).*script\s+(http\S+)(?:.*in\s+function\s+(\S+))?/i,i,j,len;for(i=4,j=0,len=lines.length;i<len;i+=2){if(lineRE.test(lines[i])){lines[j++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:ANON+"()@"+RegExp.$2+":"+RegExp.$1)+" -- "+lines[i+1].replace(/^\s+/,"");}}lines.splice(j,lines.length-j);return lines;},other:function(curr){var ANON="{anonymous}",fnRE=/function\s*([\w\-$]+)?\s*\(/i,stack=[],fn,args,maxStackSize=10;while(curr&&stack.length<maxStackSize){fn=fnRE.test(curr.toString())?RegExp.$1||ANON:ANON;args=Array.prototype.slice.call(curr["arguments"]||[]);stack[stack.length]=fn+"("+this.stringifyArguments(args)+")";try{curr=curr.caller;}catch(err){curr=null;}}return stack;},stringifyArguments:function(args){var slice=Array.prototype.slice;for(var i=0;i<args.length;++i){var arg=args[i];if(arg===undefined){args[i]="undefined";}else{if(arg===null){args[i]="null";}else{if(arg.constructor){if(arg.constructor===Array){if(arg.length<3){args[i]="["+this.stringifyArguments(arg)+"]";}else{args[i]="["+this.stringifyArguments(slice.call(arg,0,1))+"..."+this.stringifyArguments(slice.call(arg,-1))+"]";}}else{if(arg.constructor===Object){args[i]="#object";}else{if(arg.constructor===Function){args[i]="#function";}else{if(arg.constructor===String){args[i]='"'+arg+'"';}}}}}}}}return args.join(",");}};return p.run(ex);}};})(),Function:{invoke:function(ctx,func,params){if(func===null){return;}switch(typeof func){case"function":try{var args=Array.prototype.slice.call(arguments);args.shift();args.shift();return func.apply(ctx,args);}catch(e){xRTML.Console.error(e);}break;case"undefined":break;default:xRTML.Console.error("Invoke of function not possible. "+(func===null?"null":func.toString())+" is not a function.");break;}}}};xRTML.Config={logLevels:{error:0,warn:1,info:2},debug:false,logLevel:2,xrtmlActive:true,throwErrors:false,connectionAttempts:5,connectionTimeout:10000,loadORTCScript:true,ortcLibrary:document.location.protocol+"//ortc.realtime.livehtml.net/js/2.0.0/ortc.js",load:function(){var tag=document.getElementsByTagName(window.addEventListener?"xrtml:config":"config");if(tag.length>1){throw"xRTML only allows for one config tag per page.";}tag=tag[0];if(tag===undefined){return;}if(typeof tag.attributes["debug"]!=="undefined"){this.debug=xRTML.Common.Converter.toBoolean(tag.getAttribute("debug"));}if(typeof tag.attributes["loglevel"]!=="undefined"){this.logLevel=this.logLevels[tag.getAttribute("loglevel")];}if(typeof tag.attributes["xrtmlactive"]!=="undefined"){this.xrtmlActive=xRTML.Common.Converter.toBoolean(tag.getAttribute("xrtmlactive"));}if(typeof tag.attributes["throwerrors"]!=="undefined"){this.throwErrors=xRTML.Common.Converter.toBoolean(tag.getAttribute("throwerrors"));}if(typeof tag.attributes["connectionattempts"]!=="undefined"){this.connectionAttempts=xRTML.Common.Converter.toNumber(tag.getAttribute("connectionattempts"));}if(typeof tag.attributes["connectiontimeout"]!=="undefined"){this.connectionTimeout=xRTML.Common.Converter.toNumber(tag.getAttribute("connectiontimeout"));}if(typeof tag.attributes["loadortcscript"]!=="undefined"){this.loadORTCScript=xRTML.Common.Converter.toBoolean(tag.getAttribute("loadortcscript"));}if(typeof tag.attributes["remotetrace"]!=="undefined"){this.remoteTrace=xRTML.Common.Converter.toBoolean(tag.getAttribute("remotetrace"));}if(typeof tag.attributes["ortcurl"]!=="undefined"){this.ortcUrl=tag.getAttribute("ortcurl");}},remoteTrace:false};xRTML.Console=(function(){var instance=(function(){var fallback={id:null,buffer:[],style:"width: 100%; height: 40%; position: absolute; bottom:5px; left:5px; background: silver; padding: 5px; overflow: scroll;font-family:consolas,monospace;font-size:12px; ",printObject:function(obj){var output="";for(property in obj){output+=property+": "+obj[property]+"; \n";}return output;},newLine:function(statement,color){var pStatement=document.createElement("p");pStatement.style.color=color;pStatement.innerHTML=statement;fallback.id?document.getElementById(fallback.id).appendChild(pStatement):fallback.buffer.push(pStatement);},log:function(statement){fallback.newLine(statement,"black");},warn:function(statement){fallback.newLine(statement,"orange");},error:function(statement){fallback.newLine(statement,"red");},debug:function(statement){fallback.newLine(statement,"green");},init:function(){fallback.id="xRTML_Console_"+xRTML.Common.Util.idGenerator();var consoleDiv=document.createElement("div");consoleDiv.id=fallback.id;consoleDiv.style.cssText=fallback.style;for(var i=0,len=fallback.buffer.length;i<len;i++){consoleDiv.appendChild(fallback.buffer[i]);}buffer=[];document.body.appendChild(consoleDiv);consoleDiv.style.display=xRTML.Config.debug?"block":"none";if(xRTML.Config.debug){document.body.appendChild(consoleDiv);}return fallback;}},debugConsole=typeof console!=="undefined"?console:fallback;if(!window.addEventListener&&xRTML.Config.debug&&!console){xRTML.addEventListener("ready",fallback.init);}return{log:function(info){debugConsole.log(info);},warn:function(info){debugConsole.warn(info);},error:function(info){debugConsole.error(info);if(xRTML.Config.remoteTrace===true){this.dispatchEvent("onError",{error:info});}},debug:function(info){if(xRTML.Config.debug===true){debugConsole.log(info);}}};})();new Events.Provider(instance);xRTML.Console=function(){return instance;};return xRTML.Console();})();xRTML.Common.xhr=function(method,url,callback,async){this.init(method,url,callback,async);};xRTML.Common.xhr.prototype={readyStateCode:{"UNSENT":0,"OPENED":1,"HEADERS_RECEIVED":2,"LOADING":3,"DONE":4},init:function(method,url,callback,async){if(method&&url&&callback){this.create(method,url,callback,async);}},getXHR:function(){if(window.XMLHttpRequest){return new XMLHttpRequest();}else{if(window.ActiveXObject){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0");}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0");}catch(e){}try{return ActiveXObject("Microsoft.XMLHTTP");}catch(e){}}}xRTML.Console.error("This browser does not support XMLHttpRequest.");},create:function(method,url,callback,async){var self=this;self.xhr=this.getXHR();self.callback=callback;method=method.toUpperCase();self.xhr.onreadystatechange=function(){try{self.callback.apply(self.xhr,[self]);}catch(e){xRTML.Console.log(e);}};self.xhr.open(method,url,(async===true));self.xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");if(method=="POST"){self.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");self.xhr.setRequestHeader("Method","POST "+url+" HTTP/1.1");}return self.xhr;},send:function(data){if(typeof(data)!="string"){data=JSON.stringify(data);}xRTML.Console.debug("sending:"+data);this.xhr.send(data);}};xRTML.JQueryEffectManager=(function(){var uiEffects={"blind":true,"bounce":true,"clip":true,"drop":true,"explode":true,"fade":true,"fold":true,"highlight":true,"puff":true,"pulsate":true,"scale":true,"shake":true,"size":true,"slide":true,"transfer":true};function checkIfEffectFunctionAvailable(effectName){var effectAvailable=(jQuery.fn&&((typeof jQuery.fn[effectName]).toLowerCase()=="function"))||(jQuery.effects&&((typeof jQuery.effects[effectName]).toLowerCase()=="function"));if(!effectAvailable){xRTML.Console.error("Effect function "+effectName+" not available. Please import the necessary jQuery libraries for this function.");}}function callJQueryEffect(argumentsObject){if(!argumentsObject.element||!argumentsObject.effectName){xRTML.Console.error("Required arguments not found. This function takes an Object containing at least the following properties: element, effectName");}xRTML.Console.debug("jQuery effect: Running "+argumentsObject.effectName+" on element "+argumentsObject.element.id+" with options "+JSON.stringify(argumentsObject.effectOptions)+" and properties: "+JSON.stringify(argumentsObject.effectProperties));checkIfEffectFunctionAvailable(argumentsObject.effectName);try{if(uiEffects[argumentsObject.effectName]){jQuery.fn.effect.call(jQuery(argumentsObject.element),argumentsObject.effectName,argumentsObject.effectOptions,argumentsObject.effectSpeed,argumentsObject.effectCallback);}else{jQuery.fn[argumentsObject.effectName].call(jQuery(argumentsObject.element),argumentsObject.effectProperties,argumentsObject.effectOptions);}}catch(err){xRTML.Console.warn(err);}}function buildReverseEffectProperties(argumentsObject){var elementCSSProperties={};for(prop in argumentsObject.effectProperties){if(jQuery(argumentsObject.element).css(prop)){elementCSSProperties[prop]=jQuery(argumentsObject.element).css(prop);}}return elementCSSProperties;}function callJQueryEffectNow(argumentsObject){argumentsObject.effectOptions["queue"]=false;callJQueryEffect(argumentsObject);}function buildArgumentsObject(element,effect){return{element:element,effectName:effect.name,effectOptions:cloneJQueryOptions(effect.options),effectProperties:effect.cssProperties,effectSpeed:effect.speed,effectCallback:effect.callback?(typeof effect.callback=="function"?effect.callback:new Function("","return "+effect.callback+"();")):null,revert:effect.revert};}var cloneJQueryOptions=function(options){var newOptions={};for(prop in options){newOptions[prop]=options[prop];}return newOptions;};return{effectsQueue:[],effectsMap:{},init:function(xrtmlEffectElements){var effect=null;for(var i=0;i<xrtmlEffectElements.length;i++){effect=xrtmlEffectElements[i];if(this.effectsMap[effect.id]){xRTML.Console.error("All jqueryeffect id attributes should be unique.");}this.effectsMap[effect.id]={name:effect.name,options:effect.options?xRTML.Common.Util.convertAttributeValueToJSON(effect.options):undefined,cssProperties:effect.properties?xRTML.Common.Util.convertAttributeValueToJSON(effect.properties):undefined,speed:effect.speed,callback:effect.callback,revert:xRTML.Common.Converter.toBoolean(effect.revert)};}},addEffectToQueue:function(argumentsObject){if(!this.effectsQueue){this.effectsQueue=[];}this.effectsQueue.push({element:argumentsObject.element,effectId:argumentsObject.effectId});if(this.effectsMap[argumentsObject.effectId].revert){var revertEffect=jQuery.extend(true,{},this.effectsMap[argumentsObject.effectId]);revertEffect.cssProperties=buildReverseEffectProperties({effectProperties:this.effectsMap[argumentsObject.effectId].cssProperties,element:argumentsObject.element});this.effectsMap[argumentsObject.effectId+"_revert"]=revertEffect;this.effectsQueue.push({element:argumentsObject.element,effectId:argumentsObject.effectId+"_revert"});}},removeEffectFromQueue:function(element,effectId){},runAllEffects:function(){for(var i=0;i<this.effectsQueue.length;i++){var argumentsObject=buildArgumentsObject(this.effectsQueue[i].element,this.effectsMap[this.effectsQueue[i].effectId]);callJQueryEffect(argumentsObject);}},runAllEffectsNow:function(){for(var i=0;i<this.effectsQueue.length;i++){var argumentsObject=buildArgumentsObject(this.effectsQueue[i].element,this.effectsMap[this.effectsQueue[i].effectId]);callJQueryEffectNow(argumentsObject);}},runElementEffects:function(element){},runElementEffectsNow:function(element){},runEffect:function(element,effectId){},runEffectNow:function(element,effectId){},stopAllEffects:function(){},stopAllEffectsAndClearQueue:function(){for(var i=0;i<this.effectsQueue.length;i++){jQuery(this.effectsQueue[i].element).stop(false,true);}this.effectsQueue=[];},stopElementEffects:function(element){},stopElementEffectsAndClearQueue:function(element){},stopEffect:function(element,effectId){},getInstance:function(context){if(!context.jQueryEffectManagerInstance){function F(){}F.prototype=xRTML.JQueryEffectManager;return new F();}return context.jQueryEffectManagerInstance;}};})();if(typeof Function.prototype.makeSubclass!=="function"){Function.prototype.makeSubclass=function(){function Tag(){if(!(this instanceof Tag)){throw ('Constructor called without "new"');}if("init" in this){this.init.apply(this,arguments);}}Function.prototype.makeSubclass.nonconstructor.prototype=this.prototype;Tag.prototype=new Function.prototype.makeSubclass.nonconstructor();return Tag;};}Function.prototype.makeSubclass.nonconstructor=function(){};if(typeof String.prototype.parseTemplate!=="function"){String.prototype.parseTemplate=function(o){return this.replace(/\[xRTML:([^\[\]]*)\]/g,function(a,b){var r=o[b];return typeof r==="string"?r:a;});};}if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"");};}if(typeof String.prototype.isJSON!=="function"){String.prototype.isJSON=function(){return !(/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(this.replace(/"(\\.|[^"\\])*"/g,"")));};}xRTML.Tag=Object.makeSubclass();xRTML.Tag.prototype.init=function(tagObject){new Events.Provider(this);var self=this;this.onInit=function(){var e={target:self};tagObject.oninit?new Function("e","return "+tagObject.oninit+"(e);")(e):null;self.dispatchEvent("onInit");}();this.onLoad=function(){var e={target:self};tagObject.onload?new Function("e","return "+tagObject.onload+"(e);")(e):null;self.dispatchEvent("onLoad");};this.onActive=function(active){var e={target:self,active:active};tagObject.onactive?new Function("e","return "+tagObject.onactive+"(e);")(e):null;self.dispatchEvent("active",e);};this.onActivated=function(active){var e={target:self,active:active};tagObject.onactivated?new Function("e","return "+tagObject.onactivated+"(e);")(e):null;self.dispatchEvent("activated",e);};this.id=tagObject.id;this.internalId=xRTML.Common.Util.guidGenerator();this.channelId=tagObject.channelid;var targetId=tagObject.target;if(targetId){var pattern=/\.|\#|\:|\>|\-|\+|\~| /;var isTargetId=targetId.match(pattern);this.target=Sizzle(targetId);if(!this.target){xRTML.Console.error("Target element(s) not found.");}}this.triggers=[];var triggers=tagObject.triggers;if(triggers){for(var i=0;i<triggers.length;i++){this.triggers.push({name:triggers[i].name,mappings:triggers[i].mappings});}}this.receiveOwnMessages=typeof tagObject.receiveownmessages==="undefined"?false:xRTML.Common.Converter.toBoolean(tagObject.receiveownmessages);this.activate=function(active){this.active=(typeof active=="undefined"||active==null)?true:xRTML.Common.Converter.toBoolean(active);this.onActive(this.active,self);};this.active=tagObject.active;this.activate(this.active);var preProcessUDF=(function(){if(tagObject.preprocess){return typeof tagObject.preprocess=="function"?tagObject.preprocess:new Function("data","return "+tagObject.preprocess+"(data);");}return null;})();var preProcess=function(data){if(typeof preProcessUDF=="function"){preProcessUDF(data);}self.dispatchEvent("preprocessed",{data:data});};var postProcessUDF=(function(){if(tagObject.postprocess){return typeof tagObject.postprocess=="function"?tagObject.postprocess:new Function("data","return "+tagObject.postprocess+"(data);");}return null;})();var postProcess=function(data){if(typeof postProcessUDF=="function"){postProcessUDF(data);}self.dispatchEvent("postprocessed",{data:data});};var process=function(objContext,data){if(objContext.active){preProcess(data);objContext.process(data);}else{xRTML.Console.debug("Tag "+(objContext.id||objContext.internalId)+" is not active. No actions will be processed.");}var action=data.action;if(action&&action=="activate"){if(data.data){objContext.activate(data.data.active);}else{xRTML.Console.error("Activating a tag requires the message data to have the attribute 'active' set to 'true' or 'false' ");}}if(objContext.active){postProcess(data);}};this.process=function(data){var action=data.action;if(action){var mappings=[];for(var trig in this.triggers){if(data.trigger==this.triggers[trig].name&&this.triggers[trig].mappings){mappings=this.triggers[trig].mappings;for(var map in mappings){if(data.action==mappings[map].action){action=mappings[map].to;break;}}break;}}this[action]?this[action].call(this,data):xRTML.Console.debug("Action "+action+" is not supported by this Tag");}else{xRTML.Console.error("Action was not specified. A Tag instance should either override process or handle actions so if process was not overriden an action is required.");}if(this.processUDF){this.processUDF(data);}};this.callProcess=function(data){if(!data.senderId||this.internalId!=data.senderId){process(this,data);self.dispatchEvent("onprocess",{data:data});}else{if(this.internalId===data.senderId&&this.receiveOwnMessages){process(this,data);self.dispatchEvent("onprocess",{data:data});}}};var disposeUDF=tagObject.dispose?new Function("return "+tagObject.dispose+"();"):null;this.dispose=function(){if(typeof disposeUDF=="function"){disposeUDF();}this.target=null;self.dispatchEvent("dispose",{tag:this});};};xRTML.Tags.Connection=xRTML.Tag.makeSubclass();xRTML.Tags.Connection.prototype.init=function(xrtmlObj){xRTML.Tag.prototype.init.call(this,xrtmlObj);var self=this,ortcClient=null,bool={"true":true,"false":false};this.appKey=xrtmlObj.appkey;this.authToken=xrtmlObj.authtoken;this.sendRetries=parseInt(xrtmlObj.sendretries)||5;this.sendInterval=parseInt(xrtmlObj.sendinterval)||1000;this.timeout=xrtmlObj.timeout||xRTML.Config.connectionTimeout;this.connectAttempts=xrtmlObj.connectattempts||xRTML.Config.connectionAttempts;this.connectionAttemptsCounter=0;this.autoConnect=typeof xrtmlObj.autoconnect!="boolean"?(bool[xrtmlObj.autoconnect]||true):xrtmlObj.autoconnect;this.metadata=xrtmlObj.metadata;this.serverType=xrtmlObj.servertype||"IbtRealTimeSJ";this.url=xrtmlObj.url||xRTML.Config.ortcUrl||xRTML.Console.error("Connection "+(this.id||this.internalId)+": ORTC Server URL must be set.");this.isCluster=typeof bool[xrtmlObj.iscluster]!="undefined"?bool[xrtmlObj.iscluster]:true;this.messageAdapter=xrtmlObj.messageadapter;this.onCreated=xrtmlObj.oncreated;this.onConnected=xrtmlObj.onconnected;this.onDisconnected=xrtmlObj.ondisconnected;this.onSubscribed=xrtmlObj.onsubscribed;this.onUnsubscribed=xrtmlObj.onunsubscribed;this.onException=xrtmlObj.onexception;this.onReconnected=xrtmlObj.onreconnected;this.onReconnecting=xrtmlObj.onreconnecting;this.onMessage=xrtmlObj.onmessage;var onCreated=function(ortcClient){var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onCreated,e);self.dispatchEvent("onCreated",e);if(self.autoConnect){ortcClient.connect(self.appKey,self.authToken);}},onConnected=function(ortcClient){var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onConnected,e);self.dispatchEvent("onConnected",e);for(var name in self.channels){var channel=self.channels[name];if(channel.subscribe){ortcClient.subscribe(channel.name,channel.subscribeOnReconnect,self.process);}}},onDisconnected=function(ortcClient){var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onDisconnected,e);self.dispatchEvent("onDisconnected",e);},onSubscribed=function(ortcClient,channel){var e={client:self,channel:channel,target:self};xRTML.Common.Function.invoke(self,self.onSubscribed,e);self.dispatchEvent("onSubscribed",e);},onUnsubscribed=function(ortcClient,channel){var e={client:self,channel:channel,target:self};xRTML.Common.Function.invoke(self,self.onUnsubscribed,e);self.dispatchEvent("onUnsubscribed",e);if(self.channels[channel]){delete self.channels[channel];}},onException=function(ortcClient,evt){var e={client:self,event:evt,target:self};xRTML.Common.Function.invoke(self,self.onException,e);self.dispatchEvent("onException",e);},onReconnected=function(ortcClient){self.connectionAttemptsCounter=0;var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onReconnected,e);self.dispatchEvent("onReconnected",e);},onReconnecting=function(ortcClient){if(self.connectionAttemptsCounter>=self.connectAttempts){ortcClient.disconnect();}else{self.connectionAttemptsCounter++;var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onReconnecting,e);self.dispatchEvent("onReconnecting",e);}},onMessage=function(channel,message){var e={id:self.internalId,channel:channel,message:message,target:self};if(self.channels[channel].onMessage){self.channels[channel].onMessage(e);}self.channels[channel].dispatchEvent("onMessage",e);if(self.onMessage){xRTML.Common.Function.invoke(self,self.onMessage,e);}self.dispatchEvent("onMessage",e);},messageAdapter=function(message,channel){var adaptedMessage=message;if(self.messageAdapter){adaptedMessage=self.messageAdapter(message);}if(self.channels[channel]&&self.channels[channel].messageAdapter){adaptedMessage=self.channels[channel].messageAdapter(adaptedMessage);}return adaptedMessage;},retrySend=function(channel,message,retries){if(typeof message==="object"){message=message.stringify();}if(self.isCreated()&&self.isConnected()){ortcClient.send(channel,message);}else{if(++retries<=self.sendRetries){xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Retry "+retries+"/"+self.sendRetries+" in "+self.sendInterval/1000+" seconds.");setTimeout(function(){retrySend(channel,message,retries);},self.sendInterval);}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Discarding message.");}}};this.addChannel=function(c){self.channels[c.name]={name:c.name,subscribeOnReconnect:(typeof c.subscribeOnReconnect=="undefined")?true:c.subscribeOnReconnect,subscribe:(typeof c.subscribe=="undefined")?true:c.subscribe,onMessage:c.onMessage,messageAdapter:c.messageAdapter};new Events.Provider(self.channels[c.name]);self.dispatchEvent("onChannelAdded",{client:this,channel:self.channels[c.name]});return self.channels[c.name];};this.channels={};for(var i=0;i<xrtmlObj.channels.length;++i){this.addChannel(xrtmlObj.channels[i]);}this.onClientCreated=function(e){ortcClient=e.client;ortcClient.setId(self.internalId);!self.isCluster?ortcClient.setUrl(self.url):ortcClient.setClusterUrl(self.url);ortcClient.onConnected=onConnected;ortcClient.onDisconnected=onDisconnected;ortcClient.onSubscribed=onSubscribed;ortcClient.onUnsubscribed=onUnsubscribed;ortcClient.onException=onException;ortcClient.onReconnected=onReconnected;ortcClient.onReconnecting=onReconnecting;ortcClient.setConnectionTimeout(self.timeout);ortcClient.setConnectionMetadata(self.metadata);onCreated(ortcClient);};this.process=function(ortcClient,channel,message){if(message.substring(0,15)=="_X_SEND_ONLY_X_"){var mId=message.substring(15,51);if(self.internalId==mId){return;}else{message=message.substring(54);}}if(self.active){if(typeof self.preProcess=="function"){self.preProcess(ortcClient,channel,message);}onMessage(channel,message);message=messageAdapter(message,channel);try{if(xRTML.isXrtmlMessage(message)){var messageJSON=message.xrtml||JSON.parse(message).xrtml,xrtmlMessage=xRTML.createMessage(messageJSON.t,messageJSON.a,messageJSON.d,messageJSON.s);self.dispatchEvent("onXrtmlMessage",{message:xrtmlMessage});}}catch(err){xRTML.Console.error("Connection "+(self.id||self.internalId)+" error processing xRTML Message: "+message+". Error Description: "+err.name);}}else{xRTML.Console.debug("Message received wasn't processed. Connection is not active.");}};this.send=function(channel,message,sendOnly){if(typeof message==="object"){message=message.stringify();}if(this.isCreated()){if(this.isConnected()){if(this.active){if(sendOnly){message="_X_SEND_ONLY_X_"+self.internalId+"_X_"+message;}ortcClient.send(channel,message);xRTML.Console.debug("Message "+message+" sent to channel "+channel);}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Discarding message. Connection is not active.");}}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Connection not established yet. Retrying in "+this.sendInterval/1000+" seconds.");setTimeout(function(){retrySend(channel,message,0);},self.sendInterval);}}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Connection not created yet. Retrying in "+this.sendInterval/1000+" seconds.");setTimeout(function(){retrySend(channel,message,0);},self.sendInterval);}};this.connect=function(appKey,authToken){this.isCreated()?ortcClient.connect(appKey||this.appKey,authToken||this.authToken):xRTML.Console.error("Connect not possible. ORTC client not created.");};this.disconnect=function(){this.isConnected()?ortcClient.disconnect():xRTML.Console.error("Disconnect not possible. No connection established.");};this.subscribe=function(channel){channel.subscribe=true;channel=this.addChannel(channel);if(channel.subscribe){ortcClient.subscribe(channel.name,channel.subscribeOnReconnected,this.process);}};this.unsubscribe=function(name){ortcClient.unsubscribe(name);};this.isCreated=function(){return ortcClient!=null;};this.isConnected=function(){return this.isCreated()?ortcClient.getIsConnected():false;};this.isSubscribed=function(channelName){return this.isConnected()?ortcClient.isSubscribed(channelName):false;};this.getMetadata=function(){return this.isCreated()?ortcClient.getConnectionMetadata():xRTML.Console.error("ORTC client is undefined.");};this.setMetadata=function(metadata){return this.isCreated()?ortcClient.setConnectionMetadata(metadata):xRTML.Console.error("ORTC client is undefined.");};};var JSON;if(!JSON){JSON={};}(function(){function f(n){return n<10?"0"+n:n;}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key);}if(typeof rep==="function"){value=rep.call(holder,key,value);}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null";}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null";}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v;}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v);}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v;}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" ";}}else{if(typeof space==="string"){indent=space;}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify");}return str("",{"":value});};}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}return reviver.call(holder,key,value);}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);});}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j;}throw new SyntaxError("JSON.parse");};}}());(function(){var chunker=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,done=0,toString=Object.prototype.toString,hasDuplicate=false,baseHasDuplicate=true,rBackslash=/\\/g,rNonWord=/\W/;[0,0].sort(function(){baseHasDuplicate=false;return 0;});var Sizzle=function(selector,context,results,seed){results=results||[];context=context||document;var origContext=context;if(context.nodeType!==1&&context.nodeType!==9){return[];}if(!selector||typeof selector!=="string"){return results;}var m,set,checkSet,extra,ret,cur,pop,i,prune=true,contextXML=Sizzle.isXML(context),parts=[],soFar=selector;do{chunker.exec("");m=chunker.exec(soFar);if(m){soFar=m[3];parts.push(m[1]);if(m[2]){extra=m[3];break;}}}while(m);if(parts.length>1&&origPOS.exec(selector)){if(parts.length===2&&Expr.relative[parts[0]]){set=posProcess(parts[0]+parts[1],context);}else{set=Expr.relative[parts[0]]?[context]:Sizzle(parts.shift(),context);while(parts.length){selector=parts.shift();if(Expr.relative[selector]){selector+=parts.shift();}set=posProcess(selector,set);}}}else{if(!seed&&parts.length>1&&context.nodeType===9&&!contextXML&&Expr.match.ID.test(parts[0])&&!Expr.match.ID.test(parts[parts.length-1])){ret=Sizzle.find(parts.shift(),context,contextXML);context=ret.expr?Sizzle.filter(ret.expr,ret.set)[0]:ret.set[0];}if(context){ret=seed?{expr:parts.pop(),set:makeArray(seed)}:Sizzle.find(parts.pop(),parts.length===1&&(parts[0]==="~"||parts[0]==="+")&&context.parentNode?context.parentNode:context,contextXML);set=ret.expr?Sizzle.filter(ret.expr,ret.set):ret.set;if(parts.length>0){checkSet=makeArray(set);}else{prune=false;}while(parts.length){cur=parts.pop();pop=cur;if(!Expr.relative[cur]){cur="";}else{pop=parts.pop();}if(pop==null){pop=context;}Expr.relative[cur](checkSet,pop,contextXML);}}else{checkSet=parts=[];}}if(!checkSet){checkSet=set;}if(!checkSet){Sizzle.error(cur||selector);}if(toString.call(checkSet)==="[object Array]"){if(!prune){results.push.apply(results,checkSet);}else{if(context&&context.nodeType===1){for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&(checkSet[i]===true||checkSet[i].nodeType===1&&Sizzle.contains(context,checkSet[i]))){results.push(set[i]);}}}else{for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&checkSet[i].nodeType===1){results.push(set[i]);}}}}}else{makeArray(checkSet,results);}if(extra){Sizzle(extra,origContext,results,seed);Sizzle.uniqueSort(results);}return results;};Sizzle.uniqueSort=function(results){if(sortOrder){hasDuplicate=baseHasDuplicate;results.sort(sortOrder);if(hasDuplicate){for(var i=1;i<results.length;i++){if(results[i]===results[i-1]){results.splice(i--,1);}}}}return results;};Sizzle.matches=function(expr,set){return Sizzle(expr,null,null,set);};Sizzle.matchesSelector=function(node,expr){return Sizzle(expr,null,null,[node]).length>0;};Sizzle.find=function(expr,context,isXML){var set;if(!expr){return[];}for(var i=0,l=Expr.order.length;i<l;i++){var match,type=Expr.order[i];if((match=Expr.leftMatch[type].exec(expr))){var left=match[1];match.splice(1,1);if(left.substr(left.length-1)!=="\\"){match[1]=(match[1]||"").replace(rBackslash,"");set=Expr.find[type](match,context,isXML);if(set!=null){expr=expr.replace(Expr.match[type],"");break;}}}}if(!set){set=typeof context.getElementsByTagName!=="undefined"?context.getElementsByTagName("*"):[];}return{set:set,expr:expr};};Sizzle.filter=function(expr,set,inplace,not){var match,anyFound,old=expr,result=[],curLoop=set,isXMLFilter=set&&set[0]&&Sizzle.isXML(set[0]);while(expr&&set.length){for(var type in Expr.filter){if((match=Expr.leftMatch[type].exec(expr))!=null&&match[2]){var found,item,filter=Expr.filter[type],left=match[1];anyFound=false;match.splice(1,1);if(left.substr(left.length-1)==="\\"){continue;}if(curLoop===result){result=[];}if(Expr.preFilter[type]){match=Expr.preFilter[type](match,curLoop,inplace,result,not,isXMLFilter);if(!match){anyFound=found=true;}else{if(match===true){continue;}}}if(match){for(var i=0;(item=curLoop[i])!=null;i++){if(item){found=filter(item,match,i,curLoop);var pass=not^!!found;if(inplace&&found!=null){if(pass){anyFound=true;}else{curLoop[i]=false;}}else{if(pass){result.push(item);anyFound=true;}}}}}if(found!==undefined){if(!inplace){curLoop=result;}expr=expr.replace(Expr.match[type],"");if(!anyFound){return[];}break;}}}if(expr===old){if(anyFound==null){Sizzle.error(expr);}else{break;}}old=expr;}return curLoop;};Sizzle.error=function(msg){throw"Syntax error, unrecognized expression: "+msg;};var Expr=Sizzle.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(elem){return elem.getAttribute("href");},type:function(elem){return elem.getAttribute("type");}},relative:{"+":function(checkSet,part){var isPartStr=typeof part==="string",isTag=isPartStr&&!rNonWord.test(part),isPartStrNotTag=isPartStr&&!isTag;if(isTag){part=part.toLowerCase();}for(var i=0,l=checkSet.length,elem;i<l;i++){if((elem=checkSet[i])){while((elem=elem.previousSibling)&&elem.nodeType!==1){}checkSet[i]=isPartStrNotTag||elem&&elem.nodeName.toLowerCase()===part?elem||false:elem===part;}}if(isPartStrNotTag){Sizzle.filter(part,checkSet,true);}},">":function(checkSet,part){var elem,isPartStr=typeof part==="string",i=0,l=checkSet.length;if(isPartStr&&!rNonWord.test(part)){part=part.toLowerCase();for(;i<l;i++){elem=checkSet[i];if(elem){var parent=elem.parentNode;checkSet[i]=parent.nodeName.toLowerCase()===part?parent:false;}}}else{for(;i<l;i++){elem=checkSet[i];if(elem){checkSet[i]=isPartStr?elem.parentNode:elem.parentNode===part;}}if(isPartStr){Sizzle.filter(part,checkSet,true);}}},"":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck;}checkFn("parentNode",part,doneName,checkSet,nodeCheck,isXML);},"~":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck;}checkFn("previousSibling",part,doneName,checkSet,nodeCheck,isXML);}},find:{ID:function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m&&m.parentNode?[m]:[];}},NAME:function(match,context){if(typeof context.getElementsByName!=="undefined"){var ret=[],results=context.getElementsByName(match[1]);for(var i=0,l=results.length;i<l;i++){if(results[i].getAttribute("name")===match[1]){ret.push(results[i]);}}return ret.length===0?null:ret;}},TAG:function(match,context){if(typeof context.getElementsByTagName!=="undefined"){return context.getElementsByTagName(match[1]);}}},preFilter:{CLASS:function(match,curLoop,inplace,result,not,isXML){match=" "+match[1].replace(rBackslash,"")+" ";if(isXML){return match;}for(var i=0,elem;(elem=curLoop[i])!=null;i++){if(elem){if(not^(elem.className&&(" "+elem.className+" ").replace(/[\t\n\r]/g," ").indexOf(match)>=0)){if(!inplace){result.push(elem);}}else{if(inplace){curLoop[i]=false;}}}}return false;},ID:function(match){return match[1].replace(rBackslash,"");},TAG:function(match,curLoop){return match[1].replace(rBackslash,"").toLowerCase();},CHILD:function(match){if(match[1]==="nth"){if(!match[2]){Sizzle.error(match[0]);}match[2]=match[2].replace(/^\+|\s*/g,"");var test=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(match[2]==="even"&&"2n"||match[2]==="odd"&&"2n+1"||!/\D/.test(match[2])&&"0n+"+match[2]||match[2]);match[2]=(test[1]+(test[2]||1))-0;match[3]=test[3]-0;}else{if(match[2]){Sizzle.error(match[0]);}}match[0]=done++;return match;},ATTR:function(match,curLoop,inplace,result,not,isXML){var name=match[1]=match[1].replace(rBackslash,"");if(!isXML&&Expr.attrMap[name]){match[1]=Expr.attrMap[name];}match[4]=(match[4]||match[5]||"").replace(rBackslash,"");if(match[2]==="~="){match[4]=" "+match[4]+" ";}return match;},PSEUDO:function(match,curLoop,inplace,result,not){if(match[1]==="not"){if((chunker.exec(match[3])||"").length>1||/^\w/.test(match[3])){match[3]=Sizzle(match[3],null,null,curLoop);}else{var ret=Sizzle.filter(match[3],curLoop,inplace,true^not);if(!inplace){result.push.apply(result,ret);}return false;}}else{if(Expr.match.POS.test(match[0])||Expr.match.CHILD.test(match[0])){return true;}}return match;},POS:function(match){match.unshift(true);return match;}},filters:{enabled:function(elem){return elem.disabled===false&&elem.type!=="hidden";},disabled:function(elem){return elem.disabled===true;},checked:function(elem){return elem.checked===true;},selected:function(elem){if(elem.parentNode){elem.parentNode.selectedIndex;}return elem.selected===true;},parent:function(elem){return !!elem.firstChild;},empty:function(elem){return !elem.firstChild;},has:function(elem,i,match){return !!Sizzle(match[3],elem).length;},header:function(elem){return(/h\d/i).test(elem.nodeName);},text:function(elem){var attr=elem.getAttribute("type"),type=elem.type;return elem.nodeName.toLowerCase()==="input"&&"text"===type&&(attr===type||attr===null);},radio:function(elem){return elem.nodeName.toLowerCase()==="input"&&"radio"===elem.type;},checkbox:function(elem){return elem.nodeName.toLowerCase()==="input"&&"checkbox"===elem.type;},file:function(elem){return elem.nodeName.toLowerCase()==="input"&&"file"===elem.type;},password:function(elem){return elem.nodeName.toLowerCase()==="input"&&"password"===elem.type;},submit:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"submit"===elem.type;},image:function(elem){return elem.nodeName.toLowerCase()==="input"&&"image"===elem.type;},reset:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"reset"===elem.type;},button:function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&"button"===elem.type||name==="button";},input:function(elem){return(/input|select|textarea|button/i).test(elem.nodeName);},focus:function(elem){return elem===elem.ownerDocument.activeElement;}},setFilters:{first:function(elem,i){return i===0;},last:function(elem,i,match,array){return i===array.length-1;},even:function(elem,i){return i%2===0;},odd:function(elem,i){return i%2===1;},lt:function(elem,i,match){return i<match[3]-0;},gt:function(elem,i,match){return i>match[3]-0;},nth:function(elem,i,match){return match[3]-0===i;},eq:function(elem,i,match){return match[3]-0===i;}},filter:{PSEUDO:function(elem,match,i,array){var name=match[1],filter=Expr.filters[name];if(filter){return filter(elem,i,match,array);}else{if(name==="contains"){return(elem.textContent||elem.innerText||Sizzle.getText([elem])||"").indexOf(match[3])>=0;}else{if(name==="not"){var not=match[3];for(var j=0,l=not.length;j<l;j++){if(not[j]===elem){return false;}}return true;}else{Sizzle.error(name);}}}},CHILD:function(elem,match){var type=match[1],node=elem;switch(type){case"only":case"first":while((node=node.previousSibling)){if(node.nodeType===1){return false;}}if(type==="first"){return true;}node=elem;case"last":while((node=node.nextSibling)){if(node.nodeType===1){return false;}}return true;case"nth":var first=match[2],last=match[3];if(first===1&&last===0){return true;}var doneName=match[0],parent=elem.parentNode;if(parent&&(parent.sizcache!==doneName||!elem.nodeIndex)){var count=0;for(node=parent.firstChild;node;node=node.nextSibling){if(node.nodeType===1){node.nodeIndex=++count;}}parent.sizcache=doneName;}var diff=elem.nodeIndex-last;if(first===0){return diff===0;}else{return(diff%first===0&&diff/first>=0);}}},ID:function(elem,match){return elem.nodeType===1&&elem.getAttribute("id")===match;},TAG:function(elem,match){return(match==="*"&&elem.nodeType===1)||elem.nodeName.toLowerCase()===match;},CLASS:function(elem,match){return(" "+(elem.className||elem.getAttribute("class"))+" ").indexOf(match)>-1;},ATTR:function(elem,match){var name=match[1],result=Expr.attrHandle[name]?Expr.attrHandle[name](elem):elem[name]!=null?elem[name]:elem.getAttribute(name),value=result+"",type=match[2],check=match[4];return result==null?type==="!=":type==="="?value===check:type==="*="?value.indexOf(check)>=0:type==="~="?(" "+value+" ").indexOf(check)>=0:!check?value&&result!==false:type==="!="?value!==check:type==="^="?value.indexOf(check)===0:type==="$="?value.substr(value.length-check.length)===check:type==="|="?value===check||value.substr(0,check.length+1)===check+"-":false;},POS:function(elem,match,i,array){var name=match[2],filter=Expr.setFilters[name];if(filter){return filter(elem,i,match,array);}}}};var origPOS=Expr.match.POS,fescape=function(all,num){return"\\"+(num-0+1);};for(var type in Expr.match){Expr.match[type]=new RegExp(Expr.match[type].source+(/(?![^\[]*\])(?![^\(]*\))/.source));Expr.leftMatch[type]=new RegExp(/(^(?:.|\r|\n)*?)/.source+Expr.match[type].source.replace(/\\(\d+)/g,fescape));}var makeArray=function(array,results){array=Array.prototype.slice.call(array,0);if(results){results.push.apply(results,array);return results;}return array;};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType;}catch(e){makeArray=function(array,results){var i=0,ret=results||[];if(toString.call(array)==="[object Array]"){Array.prototype.push.apply(ret,array);}else{if(typeof array.length==="number"){for(var l=array.length;i<l;i++){ret.push(array[i]);}}else{for(;array[i];i++){ret.push(array[i]);}}}return ret;};}var sortOrder,siblingCheck;if(document.documentElement.compareDocumentPosition){sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0;}if(!a.compareDocumentPosition||!b.compareDocumentPosition){return a.compareDocumentPosition?-1:1;}return a.compareDocumentPosition(b)&4?-1:1;};}else{sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0;}else{if(a.sourceIndex&&b.sourceIndex){return a.sourceIndex-b.sourceIndex;}}var al,bl,ap=[],bp=[],aup=a.parentNode,bup=b.parentNode,cur=aup;if(aup===bup){return siblingCheck(a,b);}else{if(!aup){return -1;}else{if(!bup){return 1;}}}while(cur){ap.unshift(cur);cur=cur.parentNode;}cur=bup;while(cur){bp.unshift(cur);cur=cur.parentNode;}al=ap.length;bl=bp.length;for(var i=0;i<al&&i<bl;i++){if(ap[i]!==bp[i]){return siblingCheck(ap[i],bp[i]);}}return i===al?siblingCheck(a,bp[i],-1):siblingCheck(ap[i],b,1);};siblingCheck=function(a,b,ret){if(a===b){return ret;}var cur=a.nextSibling;while(cur){if(cur===b){return -1;}cur=cur.nextSibling;}return 1;};}Sizzle.getText=function(elems){var ret="",elem;for(var i=0;elems[i];i++){elem=elems[i];if(elem.nodeType===3||elem.nodeType===4){ret+=elem.nodeValue;}else{if(elem.nodeType!==8){ret+=Sizzle.getText(elem.childNodes);}}}return ret;};(function(){var form=document.createElement("div"),id="script"+(new Date()).getTime(),root=document.documentElement;form.innerHTML="<a name='"+id+"'/>";root.insertBefore(form,root.firstChild);if(document.getElementById(id)){Expr.find.ID=function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m?m.id===match[1]||typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id").nodeValue===match[1]?[m]:undefined:[];}};Expr.filter.ID=function(elem,match){var node=typeof elem.getAttributeNode!=="undefined"&&elem.getAttributeNode("id");return elem.nodeType===1&&node&&node.nodeValue===match;};}root.removeChild(form);root=form=null;})();(function(){var div=document.createElement("div");div.appendChild(document.createComment(""));if(div.getElementsByTagName("*").length>0){Expr.find.TAG=function(match,context){var results=context.getElementsByTagName(match[1]);if(match[1]==="*"){var tmp=[];for(var i=0;results[i];i++){if(results[i].nodeType===1){tmp.push(results[i]);}}results=tmp;}return results;};}div.innerHTML="<a href='#'></a>";if(div.firstChild&&typeof div.firstChild.getAttribute!=="undefined"&&div.firstChild.getAttribute("href")!=="#"){Expr.attrHandle.href=function(elem){return elem.getAttribute("href",2);};}div=null;})();if(document.querySelectorAll){(function(){var oldSizzle=Sizzle,div=document.createElement("div"),id="__sizzle__";div.innerHTML="<p class='TEST'></p>";if(div.querySelectorAll&&div.querySelectorAll(".TEST").length===0){return;}Sizzle=function(query,context,extra,seed){context=context||document;if(!seed&&!Sizzle.isXML(context)){var match=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(query);if(match&&(context.nodeType===1||context.nodeType===9)){if(match[1]){return makeArray(context.getElementsByTagName(query),extra);}else{if(match[2]&&Expr.find.CLASS&&context.getElementsByClassName){return makeArray(context.getElementsByClassName(match[2]),extra);}}}if(context.nodeType===9){if(query==="body"&&context.body){return makeArray([context.body],extra);}else{if(match&&match[3]){var elem=context.getElementById(match[3]);if(elem&&elem.parentNode){if(elem.id===match[3]){return makeArray([elem],extra);}}else{return makeArray([],extra);}}}try{return makeArray(context.querySelectorAll(query),extra);}catch(qsaError){}}else{if(context.nodeType===1&&context.nodeName.toLowerCase()!=="object"){var oldContext=context,old=context.getAttribute("id"),nid=old||id,hasParent=context.parentNode,relativeHierarchySelector=/^\s*[+~]/.test(query);if(!old){context.setAttribute("id",nid);}else{nid=nid.replace(/'/g,"\\$&");}if(relativeHierarchySelector&&hasParent){context=context.parentNode;}try{if(!relativeHierarchySelector||hasParent){return makeArray(context.querySelectorAll("[id='"+nid+"'] "+query),extra);}}catch(pseudoError){}finally{if(!old){oldContext.removeAttribute("id");}}}}}return oldSizzle(query,context,extra,seed);};for(var prop in oldSizzle){Sizzle[prop]=oldSizzle[prop];}div=null;})();}(function(){var html=document.documentElement,matches=html.matchesSelector||html.mozMatchesSelector||html.webkitMatchesSelector||html.msMatchesSelector;if(matches){var disconnectedMatch=!matches.call(document.createElement("div"),"div"),pseudoWorks=false;try{matches.call(document.documentElement,"[test!='']:sizzle");}catch(pseudoError){pseudoWorks=true;}Sizzle.matchesSelector=function(node,expr){expr=expr.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!Sizzle.isXML(node)){try{if(pseudoWorks||!Expr.match.PSEUDO.test(expr)&&!/!=/.test(expr)){var ret=matches.call(node,expr);if(ret||!disconnectedMatch||node.document&&node.document.nodeType!==11){return ret;}}}catch(e){}}return Sizzle(expr,null,null,[node]).length>0;};}})();(function(){var div=document.createElement("div");div.innerHTML="<div class='test e'></div><div class='test'></div>";if(!div.getElementsByClassName||div.getElementsByClassName("e").length===0){return;}div.lastChild.className="e";if(div.getElementsByClassName("e").length===1){return;}Expr.order.splice(1,0,"CLASS");Expr.find.CLASS=function(match,context,isXML){if(typeof context.getElementsByClassName!=="undefined"&&!isXML){return context.getElementsByClassName(match[1]);}};div=null;})();function dirNodeCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break;}if(elem.nodeType===1&&!isXML){elem.sizcache=doneName;elem.sizset=i;}if(elem.nodeName.toLowerCase()===cur){match=elem;break;}elem=elem[dir];}checkSet[i]=match;}}}function dirCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break;}if(elem.nodeType===1){if(!isXML){elem.sizcache=doneName;elem.sizset=i;}if(typeof cur!=="string"){if(elem===cur){match=true;break;}}else{if(Sizzle.filter(cur,[elem]).length>0){match=elem;break;}}}elem=elem[dir];}checkSet[i]=match;}}}if(document.documentElement.contains){Sizzle.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):true);};}else{if(document.documentElement.compareDocumentPosition){Sizzle.contains=function(a,b){return !!(a.compareDocumentPosition(b)&16);};}else{Sizzle.contains=function(){return false;};}}Sizzle.isXML=function(elem){var documentElement=(elem?elem.ownerDocument||elem:0).documentElement;return documentElement?documentElement.nodeName!=="HTML":false;};var posProcess=function(selector,context){var match,tmpSet=[],later="",root=context.nodeType?[context]:context;while((match=Expr.match.PSEUDO.exec(selector))){later+=match[0];selector=selector.replace(Expr.match.PSEUDO,"");}selector=Expr.relative[selector]?selector+"*":selector;for(var i=0,l=root.length;i<l;i++){Sizzle(selector,root[i],tmpSet);}return Sizzle.filter(later,tmpSet);};window.Sizzle=Sizzle;})();if(document.readyState=="loaded"||document.readyState=="complete"){xRTML.init();}else{Events.Manager.addEventListener(window,"load",xRTML.init);}xRTML.Tags.Execute=xRTML.Tag.makeSubclass();xRTML.registerTag("Execute");xRTML.Tags.Execute.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);this.callback=tagObject.callback;this.process=function(message){this.delegate(message);};};xRTML.Tags.Execute.prototype.delegate=function(message){var callbackMethod=message.callback?message.callback:this.callback;var fn=new Function("message","return "+callbackMethod+"(message);");return fn(message);};
